<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Callback â€” 1Quantum Auth</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .muted { color: #6b7280 }
    .small { font-size: 0.9rem }
    .center { text-align: center }
    img.avatar { border-radius: 8px; width: 72px; height: 72px; object-fit: cover; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Completing sign-in</h1>
    <div class="card">
      <p class="muted">This page will exchange the code for a token via the server.</p>
      <div id="status"><em>Parsing callback parameters...</em></div>

      <div id="user" style="display:none" class="center">
        <img id="avatar" class="avatar" src="" alt="avatar"/>
        <h2 id="username"></h2>
        <pre id="userinfo" style="max-height:300px;overflow:auto"></pre>
      </div>

      <pre id="output" style="display:none"></pre>

      <p id="back" class="small"><a href="/">Back to home</a></p>
    </div>
  </div>

  <script>
    // parse ?a=b&c=d
    function parseQuery(qs) {
      const params = {};
      const q = qs.replace(/^\?/, '');
      if (!q) return params;
      for (const part of q.split('&')) {
        if (!part) continue;
        const [k, v] = part.split('=');
        params[decodeURIComponent(k)] = decodeURIComponent(v || '');
      }
      return params;
    }

    async function finishAuth() {
      const params = parseQuery(window.location.search);
      const statusEl = document.getElementById('status');
      const outputEl = document.getElementById('output');
      const userEl = document.getElementById('user');
      const usernameEl = document.getElementById('username');
      const avatarEl = document.getElementById('avatar');
      const userinfoEl = document.getElementById('userinfo');

      if (!params.code) {
        statusEl.innerHTML = '<strong style="color:#b91c1c">Missing "code" in URL.</strong> Make sure the OAuth app callback is configured to this URL.';
        return;
      }

      statusEl.textContent = 'Exchanging code with server...';

      try {
        const resp = await fetch('/exchange', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: params.code, state: params.state })
        });

        const data = await resp.json().catch(() => null);

        if (!resp.ok) {
          statusEl.innerHTML = '<strong style="color:#b91c1c">Exchange failed</strong>';
          outputEl.style.display = 'block';
          outputEl.textContent = JSON.stringify(data || { status: resp.status }, null, 2);
          return;
        }

        if (data && data.success && data.user) {
          statusEl.innerHTML = '<strong style="color:#059669">Authorization complete</strong>';
          userEl.style.display = 'block';
          usernameEl.textContent = data.user.login || data.user.name || 'Unknown';
          avatarEl.src = data.user.avatar_url || '';
          userinfoEl.textContent = JSON.stringify(data.user, null, 2);
          outputEl.style.display = 'none';
        } else {
          statusEl.innerHTML = '<strong style="color:#b91c1c">Not authorized</strong>';
          outputEl.style.display = 'block';
          outputEl.textContent = JSON.stringify(data || {}, null, 2);
        }
      } catch (err) {
        statusEl.innerHTML = '<strong style="color:#b91c1c">Request error</strong>';
        outputEl.style.display = 'block';
        outputEl.textContent = String(err);
      }
    }

    // Run on load
    finishAuth();
  </script>
</body>
</html>
